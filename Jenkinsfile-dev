pipeline {
    agent { label 'bttp' }

    environment {
        NODE_PATH = "/home/jenkins/.nvm/versions/node/v20.19.4/bin"
        PATH = "${NODE_PATH}:${env.PATH}"
    }

    stages {
        stage('Info') {
            steps {
                script {
                    sh '''
                        echo "====== Checking build info ======"
                        export PATH=$PATH:/usr/local/bin
                        echo "Node path: \$(which node)"
                        echo "PNPM path: \$(which pnpm)"
                        node -v
                        pnpm -v
                        echo "====== Check Done ======"
                    '''
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    export PATH=$PATH:/usr/local/bin
                    pnpm install
                '''
            }
        }

        stage('Build') {
            steps {
                script {
                    sh '''
                        export PATH=$PATH:/usr/local/bin
                        pnpm build                       
                        cp -r dist/static dist/standalone/dist/
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def targetDir = '/var/www/html/FE_BTTP/standalone'
                    def timestamp = new Date().format('yyyyMMdd_HHmmss')
                    def backupDir = "/var/www/html/FE_BTTP/standalone_${timestamp}"

                    sh """#!/bin/bash
                        set -e

                        echo "üì¶ Checking if current standalone folder exists..."
                        if [ -d '${targetDir}' ]; then
                            echo "üìÅ Found old standalone, backing up to ${backupDir}"
                            sudo cp -R ${targetDir} ${backupDir}
                            sudo rm -rf ${targetDir}
                        else
                            echo "‚ö†Ô∏è No existing standalone folder found"
                        fi

                        echo "üì§ Copying new standalone build..."
                        sudo cp -r ${WORKSPACE}/dist/standalone ${targetDir}
                        sudo chmod -R 755 ${targetDir}

                        echo "üîÅ Restarting Next.js service..."
                        sudo systemctl restart bttp-fe.service

                        echo "‚úÖ Deployment completed!"
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful!"
        }
        failure {
            echo "‚ùå Deployment failed!"
        }
    }
}
